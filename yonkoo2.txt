
-- Utility function to make frames draggable
local function MakeDraggable(topbarobject, object)
	local Dragging = nil
	local DragInput = nil
	local DragStart = nil
	local StartPosition = nil

	local function Update(input)
		local Delta = input.Position - DragStart
		object.Position = UDim2.new(StartPosition.X.Scale, StartPosition.X.Offset + Delta.X, StartPosition.Y.Scale, StartPosition.Y.Offset + Delta.Y)
	end

	topbarobject.InputBegan:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
			Dragging = true
			DragStart = input.Position
			StartPosition = object.Position

			input.Changed:Connect(function()
				if input.UserInputState == Enum.UserInputState.End then
					Dragging = false
				end
			end)
		end
	end)

	topbarobject.InputChanged:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
			DragInput = input
		end
	end)

	game:GetService("UserInputService").InputChanged:Connect(function(input)
		if input == DragInput and Dragging then
			Update(input)
		end
	end)
end

function Library:CreateWindow(Config)
	local WindowName = Config.Name or "UI Library"
	
	-- Main ScreenGui
	local ScreenGui = Instance.new("ScreenGui")
	ScreenGui.Name = "CustomLibrary"
	ScreenGui.ResetOnSpawn = false
    -- Handle potential errors if CoreGui is restricted (for Studio testing)
    if game:GetService("RunService"):IsStudio() then
        ScreenGui.Parent = game.Players.LocalPlayer:WaitForChild("PlayerGui")
    else
        pcall(function() ScreenGui.Parent = game:GetService("CoreGui") end)
        if not ScreenGui.Parent then ScreenGui.Parent = game.Players.LocalPlayer:WaitForChild("PlayerGui") end
    end

	-- Main Frame
	local MainFrame = Instance.new("Frame")
	MainFrame.Name = "MainFrame"
	MainFrame.Parent = ScreenGui
	MainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 35)
	MainFrame.BorderSizePixel = 0
	MainFrame.Position = UDim2.new(0.5, -250, 0.5, -175)
	MainFrame.Size = UDim2.new(0, 500, 0, 350)
	MainFrame.ClipsDescendants = true

	local UICorner = Instance.new("UICorner")
	UICorner.CornerRadius = UDim.new(0, 10)
	UICorner.Parent = MainFrame

	-- Topbar (Header)
	local Topbar = Instance.new("Frame")
	Topbar.Name = "Topbar"
	Topbar.Parent = MainFrame
	Topbar.BackgroundColor3 = Color3.fromRGB(45, 45, 50)
	Topbar.BorderSizePixel = 0
	Topbar.Size = UDim2.new(1, 0, 0, 40)
	
	local TopbarCorner = Instance.new("UICorner")
	TopbarCorner.CornerRadius = UDim.new(0, 10)
	TopbarCorner.Parent = Topbar

	-- Title
	local TitleLabel = Instance.new("TextLabel")
	TitleLabel.Parent = Topbar
	TitleLabel.BackgroundTransparency = 1
	TitleLabel.Position = UDim2.new(0, 15, 0, 0)
	TitleLabel.Size = UDim2.new(1, -30, 1, 0)
	TitleLabel.Font = Enum.Font.GothamBold
	TitleLabel.Text = WindowName
	TitleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
	TitleLabel.TextSize = 18
	TitleLabel.TextXAlignment = Enum.TextXAlignment.Left

	-- Container for Tabs (Left Side)
	local TabContainer = Instance.new("ScrollingFrame")
	TabContainer.Name = "TabContainer"
	TabContainer.Parent = MainFrame
	TabContainer.BackgroundColor3 = Color3.fromRGB(35, 35, 40)
	TabContainer.BorderSizePixel = 0
	TabContainer.Position = UDim2.new(0, 10, 0, 50)
	TabContainer.Size = UDim2.new(0, 120, 1, -60)
	TabContainer.ScrollBarThickness = 2
    TabContainer.CanvasSize = UDim2.new(0,0,0,0)

	local TabListLayout = Instance.new("UIListLayout")
	TabListLayout.Parent = TabContainer
	TabListLayout.SortOrder = Enum.SortOrder.LayoutOrder
	TabListLayout.Padding = UDim.new(0, 5)

    -- Container for Pages (Right Side)
    local PageContainer = Instance.new("Frame")
    PageContainer.Name = "PageContainer"
    PageContainer.Parent = MainFrame
    PageContainer.BackgroundTransparency = 1
    PageContainer.Position = UDim2.new(0, 140, 0, 50)
    PageContainer.Size = UDim2.new(1, -150, 1, -60)

	MakeDraggable(Topbar, MainFrame)

	local Window = {}
    local FirstTab = true

	function Window:CreateTab(TabName)
        -- Tab Button
		local TabButton = Instance.new("TextButton")
		TabButton.Name = TabName .. "Button"
		TabButton.Parent = TabContainer
		TabButton.BackgroundColor3 = Color3.fromRGB(45, 45, 50)
		TabButton.BorderSizePixel = 0
		TabButton.Size = UDim2.new(1, 0, 0, 35)
		TabButton.Font = Enum.Font.GothamMedium
		TabButton.Text = TabName
		TabButton.TextColor3 = Color3.fromRGB(200, 200, 200)
		TabButton.TextSize = 14
        
        local TabCorner = Instance.new("UICorner")
        TabCorner.CornerRadius = UDim.new(0, 6)
        TabCorner.Parent = TabButton

        -- Page Frame (Holds the elements for this tab)
        local Page = Instance.new("ScrollingFrame")
        Page.Name = TabName .. "Page"
        Page.Parent = PageContainer
        Page.BackgroundTransparency = 1
        Page.Size = UDim2.new(1, 0, 1, 0)
        Page.ScrollBarThickness = 4
        Page.Visible = false -- Hidden by default
        
        local PageLayout = Instance.new("UIListLayout")
        PageLayout.Parent = Page
        PageLayout.SortOrder = Enum.SortOrder.LayoutOrder
        PageLayout.Padding = UDim.new(0, 5)
        
        -- Auto-resize canvas
        PageLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
            Page.CanvasSize = UDim2.new(0, 0, 0, PageLayout.AbsoluteContentSize.Y + 10)
        end)

        -- Handle Tab Switching
        TabButton.MouseButton1Click:Connect(function()
            for _, v in pairs(PageContainer:GetChildren()) do
                v.Visible = false
            end
            for _, v in pairs(TabContainer:GetChildren()) do
                if v:IsA("TextButton") then
                    v.BackgroundColor3 = Color3.fromRGB(45, 45, 50)
                    v.TextColor3 = Color3.fromRGB(200, 200, 200)
                end
            end
            Page.Visible = true
            TabButton.BackgroundColor3 = Color3.fromRGB(60, 120, 255) -- Active Color
            TabButton.TextColor3 = Color3.fromRGB(255, 255, 255)
        end)

        -- Select first tab automatically
        if FirstTab then
            FirstTab = false
            Page.Visible = true
            TabButton.BackgroundColor3 = Color3.fromRGB(60, 120, 255)
            TabButton.TextColor3 = Color3.fromRGB(255, 255, 255)
        end

		local TabFunctions = {}

        function TabFunctions:CreateSection(SectionName)
            local SectionLabel = Instance.new("TextLabel")
            SectionLabel.Parent = Page
            SectionLabel.BackgroundTransparency = 1
            SectionLabel.Size = UDim2.new(1, 0, 0, 25)
            SectionLabel.Font = Enum.Font.GothamBold
            SectionLabel.Text = "  " .. SectionName
            SectionLabel.TextColor3 = Color3.fromRGB(150, 150, 150)
            SectionLabel.TextSize = 12
            SectionLabel.TextXAlignment = Enum.TextXAlignment.Left
        end

		function TabFunctions:CreateButton(ButtonText, Callback)
            Callback = Callback or function() end
            
			local Button = Instance.new("TextButton")
			Button.Parent = Page
			Button.BackgroundColor3 = Color3.fromRGB(45, 45, 50)
			Button.Size = UDim2.new(1, -10, 0, 35) -- Slight padding
			Button.Font = Enum.Font.Gotham
			Button.Text = ButtonText
			Button.TextColor3 = Color3.fromRGB(255, 255, 255)
			Button.TextSize = 14
            
            local BtnCorner = Instance.new("UICorner")
            BtnCorner.CornerRadius = UDim.new(0, 6)
            BtnCorner.Parent = Button
            
            local BtnPadding = Instance.new("UIPadding")
            BtnPadding.PaddingLeft = UDim.new(0, 10)
            BtnPadding.Parent = Button

			Button.MouseButton1Click:Connect(function()
                -- Add a simple click effect
                local originalColor = Button.BackgroundColor3
                Button.BackgroundColor3 = Color3.fromRGB(60, 60, 65)
                task.wait(0.1)
                Button.BackgroundColor3 = originalColor
				pcall(Callback)
			end)
		end
        
        function TabFunctions:CreateToggle(ToggleText, DefaultState, Callback)
            Callback = Callback or function() end
            local Toggled = DefaultState or false

            local ToggleFrame = Instance.new("TextButton") -- Using button for the whole frame
            ToggleFrame.Parent = Page
            ToggleFrame.BackgroundColor3 = Color3.fromRGB(45, 45, 50)
            ToggleFrame.Size = UDim2.new(1, -10, 0, 35)
            ToggleFrame.Font = Enum.Font.Gotham
            ToggleFrame.Text = ""
            ToggleFrame.AutoButtonColor = false

            local TogCorner = Instance.new("UICorner")
            TogCorner.CornerRadius = UDim.new(0, 6)
            TogCorner.Parent = ToggleFrame
            
            local Label = Instance.new("TextLabel")
            Label.Parent = ToggleFrame
            Label.BackgroundTransparency = 1
            Label.Position = UDim2.new(0, 10, 0, 0)
            Label.Size = UDim2.new(1, -50, 1, 0)
            Label.Font = Enum.Font.Gotham
            Label.Text = ToggleText
            Label.TextColor3 = Color3.fromRGB(255, 255, 255)
            Label.TextSize = 14
            Label.TextXAlignment = Enum.TextXAlignment.Left
            
            local Indicator = Instance.new("Frame")
            Indicator.Parent = ToggleFrame
            Indicator.Position = UDim2.new(1, -30, 0.5, -10)
            Indicator.Size = UDim2.new(0, 20, 0, 20)
            Indicator.BackgroundColor3 = Toggled and Color3.fromRGB(60, 255, 100) or Color3.fromRGB(255, 60, 60)
            
            local IndCorner = Instance.new("UICorner")
            IndCorner.CornerRadius = UDim.new(0, 4)
            IndCorner.Parent = Indicator

            ToggleFrame.MouseButton1Click:Connect(function()
                Toggled = not Toggled
                Indicator.BackgroundColor3 = Toggled and Color3.fromRGB(60, 255, 100) or Color3.fromRGB(255, 60, 60)
                pcall(Callback, Toggled)
            end)
        end

		return TabFunctions
	end

	return Window
end

--[[